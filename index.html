<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>IntuBlade Adoption Across the U.S.</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet" />

  <style>
    :root{
      --bg:#0f0f10;
      --text:#ffffff;
      --muted:#a9a9ad;
      --accent:#FF5722; /* marker orange */
      --panel:rgba(22,22,24,0.92);
      --border:rgba(255,255,255,.08);
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:'Roboto',sans-serif;}
    #map{height:100vh;width:100%;background:var(--bg);}

    /* Title */
    .map-title{
      position:absolute;top:16px;left:50%;transform:translateX(-50%);
      padding:12px 20px;background:var(--panel);color:var(--text);
      border-radius:999px;z-index:1100;font-size:20px;font-weight:700;letter-spacing:.3px;
      box-shadow:0 8px 24px rgba(0,0,0,.35);border:1px solid var(--border);
      backdrop-filter: blur(6px);-webkit-backdrop-filter: blur(6px);
    }

    /* Trust band (top-right) */
    .trust-band{
      position:absolute;top:16px;right:16px;z-index:1100;
      background:var(--panel);border:1px solid var(--border);border-radius:10px;
      padding:8px 12px;font-size:12px;color:var(--muted);
      display:flex;gap:10px;align-items:center;
    }
    .trust-dot{width:8px;height:8px;border-radius:999px;background:var(--accent);opacity:.85;box-shadow:0 0 8px var(--accent);}

    /* Legend toggle (bottom-left) */
    .legend{
      position:absolute;left:16px;bottom:16px;z-index:1100;max-width:280px;
    }
    .legend-toggle{
      display:inline-flex;gap:8px;align-items:center;cursor:pointer;
      background:var(--panel);border:1px solid var(--border);color:var(--text);
      padding:8px 12px;border-radius:999px;font-weight:600;font-size:13px;
    }
    .legend-panel{
      margin-top:10px;background:var(--panel);border:1px solid var(--border);
      border-radius:12px;padding:12px 12px 8px 12px;display:none;
    }
    .legend-row{display:flex;align-items:center;gap:10px;margin:6px 0;}
    .legend-swatch{width:18px;height:12px;border-radius:3px;box-shadow:0 0 10px rgba(255,87,34,.35);}
    .legend-desc{font-size:13px;color:#eaeaea;}
    .legend-sub{font-size:12px;color:var(--muted);margin-top:6px;}

    /* CTA card (bottom-right) */
    .cta{
      position:absolute;right:16px;bottom:16px;z-index:1100;
      background:var(--panel);border:1px solid var(--border);border-radius:16px;
      padding:12px;box-shadow:0 8px 24px rgba(0,0,0,.35);width:280px;
    }
    .cta h4{margin:0 0 8px 0;font-size:15px;}
    .cta p{margin:0 0 12px 0;font-size:13px;color:var(--muted);}
    .cta-actions{display:flex;gap:8px;flex-wrap:wrap;}
    .btn{
      cursor:pointer;border-radius:10px;border:1px solid var(--border);
      padding:8px 10px;font-weight:700;font-size:13px;background:#171719;color:#fff;
      text-decoration:none;display:inline-block;
    }
    .btn.primary{
      background:linear-gradient(180deg, rgba(255,87,34,0.95), rgba(255,87,34,0.8));
      border:1px solid rgba(255,87,34,0.55);box-shadow:0 0 16px rgba(255,87,34,.35);
    }

    /* Leaflet popups, attribution */
    .leaflet-popup-content-wrapper,.leaflet-popup-tip{
      background:var(--panel);color:var(--text);border:1px solid var(--border);
    }
    .leaflet-control-attribution{
      background:rgba(22,22,24,0.8) !important;color:var(--muted) !important;
      border:1px solid var(--border) !important;border-radius:6px !important;padding:2px 6px !important;
    }

    /* Panes for effects */
    .leaflet-pane.glow-pane svg path {
      mix-blend-mode: screen;
      filter:
        drop-shadow(0 0 6px  rgba(255,87,34,0.55))
        drop-shadow(0 0 14px rgba(255,87,34,0.42))
        drop-shadow(0 0 28px rgba(255,87,34,0.28));
    }
    .leaflet-pane.outline-pane svg path { mix-blend-mode: normal; }

    /* Pulsing metro dots (created via L.divIcon in JS) */
    .pulse-dot{
      width:10px;height:10px;border-radius:999px;background:var(--accent);
      box-shadow:0 0 14px rgba(255,87,34,.55),0 0 28px rgba(255,87,34,.35);
      animation:pulse 1.6s infinite ease-in-out;
      opacity:.8;
    }
    .pulse-dot.t1{opacity:.25}
    .pulse-dot.t2{opacity:.4}
    .pulse-dot.t3{opacity:.6}
    .pulse-dot.t4{opacity:.8}
    .pulse-dot.t5{opacity:.95}
    @keyframes pulse{
      0%{transform:scale(0.95);box-shadow:0 0 10px rgba(255,87,34,.4),0 0 20px rgba(255,87,34,.25);}
      50%{transform:scale(1.12);box-shadow:0 0 16px rgba(255,87,34,.6),0 0 34px rgba(255,87,34,.35);}
      100%{transform:scale(0.95);box-shadow:0 0 10px rgba(255,87,34,.4),0 0 20px rgba(255,87,34,.25);}
    }

    /* Distributor badge pin (SVG injected via JS, class used for styling) */
    .badge-pin{
      filter:drop-shadow(0 0 8px rgba(255,87,34,.45));
    }

    /* Mobile tweaks */
    @media (max-width: 640px){
      .map-title{font-size:16px;padding:10px 14px}
      .trust-band{font-size:11px;padding:6px 10px}
      .cta{width:auto;left:16px;right:16px}
    }

    /* a11y helpers */
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;}
    .focus-ring:focus{outline:2px solid #fff;outline-offset:2px;border-radius:8px;}
  </style>
</head>
<body>
  <h1 class="sr-only">IntuBlade Adoption Map</h1>

  <div class="map-title" role="region" aria-label="Map title">IntuBlade Adoption Across the U.S.</div>

  <div class="trust-band" role="note" aria-label="About this view">
    <span class="trust-dot" aria-hidden="true"></span>
    <span>Qualitative, anonymized activity</span>
    <span aria-hidden="true">•</span>
    <span>Last updated: <strong id="lastUpdated">—</strong></span>
  </div>

  <!-- Legend -->
  <div class="legend" role="region" aria-label="Legend">
    <button id="legendToggle" class="legend-toggle focus-ring" aria-expanded="false" aria-controls="legendPanel" type="button">
      <svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true"><path fill="#fff" d="M3 6h18v2H3zm0 5h12v2H3zm0 5h6v2H3z"/></svg>
      Where IntuBlade is active
    </button>
    <div id="legendPanel" class="legend-panel" hidden>
      <div class="legend-row">
        <span class="legend-swatch" style="background:rgba(255,87,34,0.90)"></span>
        <div class="legend-desc"><strong>Anchor</strong> — highest visible activity</div>
      </div>
      <div class="legend-row">
        <span class="legend-swatch" style="background:rgba(255,87,34,0.75)"></span>
        <div class="legend-desc"><strong>Strong</strong> — high activity</div>
      </div>
      <div class="legend-row">
        <span class="legend-swatch" style="background:rgba(255,87,34,0.55)"></span>
        <div class="legend-desc"><strong>Established</strong> — steady activity</div>
      </div>
      <div class="legend-row">
        <span class="legend-swatch" style="background:rgba(255,87,34,0.35)"></span>
        <div class="legend-desc"><strong>Growing</strong> — building momentum</div>
      </div>
      <div class="legend-row">
        <span class="legend-swatch" style="background:rgba(255,87,34,0.18)"></span>
        <div class="legend-desc"><strong>Emerging</strong> — early presence</div>
      </div>
      <div class="legend-row">
        <span class="legend-swatch" style="background:rgba(255,87,34,0.00);border:1px solid rgba(255,255,255,.2)"></span>
        <div class="legend-desc"><strong>—</strong> — no current activity</div>
      </div>
      <div class="legend-sub">Hover a state to see its status. Metro dots are snapped to major cities; exact sites are anonymized.</div>
    </div>
  </div>

  <!-- CTA -->
  <aside class="cta" role="complementary" aria-label="Purchase or contact">
    <h4>Purchase today or contact us</h4>
    <p>Order IntuBlade now or reach our team with questions.</p>
    <div class="cta-actions">
      <a class="btn primary focus-ring"
         href="https://payments-na1.hubspot.com/payments/NDyFTGDQKt?referrer=PAYMENT_LINK"
         target="_blank" rel="noopener"
         aria-label="Purchase IntuBlade now">
        Purchase Now
      </a>
      <button id="btnContact" class="btn focus-ring" type="button" aria-label="Contact IntuBlade">Contact Us</button>
      <button id="btnSnapshot" class="btn focus-ring" type="button" title="Save a PNG snapshot of this map">Save snapshot</button>
    </div>
  </aside>

  <!-- Map container -->
  <div id="map" role="application" aria-label="Interactive U.S. map showing anonymized IntuBlade adoption tiers"></div>

  <!-- Scripts (order matters) -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script src="https://unpkg.com/topojson-client@3"></script>

  <!-- html2canvas for PNG export (no keys required) -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <!-- Your app logic -->
  <script src="script.js"></script>

  <script>
    // Lightweight UI wiring for legend, timestamp, and CTA; core map logic lives in script.js
    (function(){
      const toggle = document.getElementById('legendToggle');
      const panel  = document.getElementById('legendPanel');
      if(toggle && panel){
        toggle.addEventListener('click', () => {
          const expanded = toggle.getAttribute('aria-expanded') === 'true';
          toggle.setAttribute('aria-expanded', String(!expanded));
          if(expanded){ panel.setAttribute('hidden',''); panel.style.display='none'; }
          else { panel.removeAttribute('hidden'); panel.style.display='block'; }
        });
      }
      // Timestamp
      const ts = document.getElementById('lastUpdated');
      if(ts){
        const now = new Date();
        const opts = { year:'numeric', month:'short', day:'2-digit' };
        ts.textContent = now.toLocaleDateString(undefined, opts);
      }

      // Contact button → mailto
      const btnContact = document.getElementById('btnContact');
      if(btnContact){
        btnContact.addEventListener('click', function(){
          const subject = encodeURIComponent('IntuBlade inquiry');
          const body = encodeURIComponent(
            'Hi IntuBlade team,%0D%0A%0D%0A' +
            'I would like to get in touch about IntuBlade.%0D%0A' +
            'Please contact me with next steps.%0D%0A%0D%0A' +
            '—%0D%0A' +
            'Sent from: ' + location.href
          );
          window.location.href = `mailto:contact@intublade.com?subject=${subject}&body=${body}`;
        });
      }

      // Snapshot handled in script.js so it captures Leaflet tiles and overlays;
      // this just ensures the button exists for that handler to hook into.
    })();
  </script>
</body>
</html>
